<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FLYMILY — מנהל נסיעות</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

  <!-- App styles -->
  <link rel="stylesheet" href="./style.css" />

  <!-- Day.js -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/advancedFormat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/utc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/timezone.js"></script>

  <!-- jsPDF + autotable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- docx (Word) -->
  <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.umd.js"></script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 64 64%27%3E%3Ctext y=%2750%27 x=%2710%27 font-size=%2750%27%3E✈️%3C/text%3E%3C/svg%3E">
</head>
<body data-theme="dark">
  <div class="app">
    <header>
      <div class="brand">✈️ FLYMILY</div>
      <div class="spacer"></div>
      <button id="btnTheme" class="btn">מצב כהה/בהיר</button>
      <button id="btnLogin" class="btn primary">התחברות / הרשמה</button>
      <button id="btnLogout" class="btn" style="display:none">התנתקות</button>
    </header>

    <div class="container">
      <aside class="sidebar" id="sidebar">
        <div class="section-title">
          <h2 style="margin:0">הנסיעות שלי</h2>
          <div class="spacer"></div>
          <button id="btnNewTrip" class="btn primary">+ נסיעה חדשה</button>
        </div>
        <div class="list-actions">
          <input id="searchTrips" class="input" placeholder="חפש נסיעה" />
          <button id="btnSortTrips" class="btn">מיין תאריך יציאה</button>
        </div>
        <div class="list-actions">
          <button id="btnViewGrid" class="btn">גלריה</button>
          <button id="btnViewList" class="btn">רשימה</button>
        </div>
        <div id="tripList" class="grid" aria-live="polite"></div>
      </aside>

      <main class="content" id="main">
        <nav class="tabs" id="tabs" style="display:none">
          <button data-tab="overview" class="active">הצג הכל</button>
          <button data-tab="meta">נתוני נסיעה</button>
          <button data-tab="expenses">הוצאות</button>
          <button data-tab="journal">יומן יומי</button>
          <button data-tab="map">מפה</button>
          <button data-tab="share">ייבוא / ייצוא / שיתוף</button>
        </nav>

        <section id="view-overview" class="tabview" hidden>
          <h2>סקירה כללית</h2>
          <div class="cards">
            <div class="card">
              <h3>נתוני נסיעה</h3>
              <div id="metaSummary" class="muted"></div>
            </div>
            <div class="card">
              <h3>הוצאות (אחרונות)</h3>
              <table>
                <thead><tr><th>תיאור</th><th>קטגוריה</th><th>סכום</th><th>תאריך</th></tr></thead>
                <tbody id="tblRecentExpenses"></tbody>
              </table>
            </div>
            <div class="card">
              <h3>יומן יומי (אחרונים)</h3>
              <table>
                <thead><tr><th>תאריך</th><th>מקום</th><th>תיאור</th></tr></thead>
                <tbody id="tblRecentJournal"></tbody>
              </table>
            </div>
            <div class="card">
              <h3>מיקומים אחרונים</h3>
              <div id="miniMap" style="height:280px" class="leaflet-container"></div>
            </div>
          </div>
        </section>

        <section id="view-meta" class="tabview" hidden>
          <h2>נתוני נסיעה</h2>
          <div class="row">
            <div class="card">
              <label>יעד<input id="metaDestination" class="input"/></label>
              <div class="row"><label>תאריך התחלה<input type="date" id="metaStart" class="input"></label><label>תאריך סיום<input type="date" id="metaEnd" class="input"></label></div>
              <label>משתתפים (מופרדים בפסיק)<input id="metaPeople" class="input"/></label>
              <label>סוגי טיול (עסקים/פנאי/משפחה...)<input id="metaTypes" class="input"/></label>
              <div class="row">
                <button id="btnSaveMeta" class="btn primary">שמור</button>
                <button id="btnVerifyOnMap" class="btn">אמת במפה</button>
              </div>
            </div>
            <div class="card">
              <h3>תקציב</h3>
              <div class="row"><label>USD<input id="bUSD" type="number" step="0.01" class="input"></label><label>EUR<input id="bEUR" type="number" step="0.01" class="input"></label><label>ILS<input id="bILS" type="number" step="0.01" class="input"></label></div>
              <div class="row"><button id="btnBudgetEdit" class="btn">ערוך תקציב</button><span class="muted">שינוי אחד יעדכן את השאר לפי שערים</span></div>
              <details style="margin-top:8px"><summary class="muted">שערי המרה (ניתנים לעריכה)</summary>
                <div class="row"><label>USD→EUR<input id="rateUSDEUR" type="number" step="0.0001" class="input"></label><label>USD→ILS<input id="rateUSDILS" type="number" step="0.0001" class="input"></label></div>
              </details>
            </div>
          </div>
        </section>

        <section id="view-expenses" class="tabview" hidden>
          <div class="section-title"><h2 style="margin:0">ניהול תקציב</h2></div>
          <div class="cards">
            <div class="card" id="expenseSummary"></div>
          </div>
          <div class="list-actions">
            <button id="btnAddExpense" class="btn primary">הוסף הוצאה</button>
            <button id="btnSortExpenses" class="btn">מיין</button>
          </div>
          <div class="card">
            <table>
              <thead><tr><th></th><th>תיאור</th><th>קטגוריה</th><th>סכום</th><th>מטבע</th><th>תאריך</th></tr></thead>
              <tbody id="tblExpenses"></tbody>
            </table>
          </div>
        </section>

        <section id="view-journal" class="tabview" hidden>
          <div class="list-actions">
            <button id="btnAddJournal" class="btn primary">הוסף רישום</button>
            <button id="btnSortJournal" class="btn">מיין</button>
          </div>
          <div class="card">
            <table>
              <thead><tr><th></th><th>תאריך</th><th>מקום</th><th>תיאור</th></tr></thead>
              <tbody id="tblJournal"></tbody>
            </table>
          </div>
        </section>

        <section id="view-map" class="tabview" hidden>
          <div style="position:relative">
            <div class="map-toolbar">
              <button id="btnToggleSpent" class="btn">איפה ביזבזתי</button>
              <button id="btnToggleVisited" class="btn">איפה טיילתי</button>
            </div>
            <div id="bigMap" class="leaflet-container"></div>
          </div>
        </section>

        <section id="view-share" class="tabview" hidden>
          <h2>ייבוא / ייצוא / שיתוף</h2>
          <div class="cards">
            <div class="card">
              <h3>ייבוא JSON</h3>
              <input type="file" id="importFile" accept="application/json" class="input"/>
              <div class="row"><button id="btnImport" class="btn primary">ייבא</button></div>
            </div>
            <div class="card">
              <h3>ייצוא</h3>
              <div class="row">
                <select id="exportWithExpenses" class="input"><option value="yes">עם הוצאות</option><option value="no">בלי הוצאות</option></select>
              </div>
              <div class="row">
                <button id="btnExportPDF" class="btn">PDF</button>
                <button id="btnExportExcel" class="btn">Excel</button>
                <button id="btnExportWord" class="btn">Word</button>
                <button id="btnExportGPX" class="btn">GPX</button>
              </div>
            </div>
            <div class="card">
              <h3>שיתוף</h3>
              <div class="row">
                <button id="btnEnableShare" class="btn">הפעל שיתוף</button>
                <button id="btnDisableShare" class="btn danger">בטל שיתוף</button>
              </div>
              <div class="row">
                <input id="shareLink" class="input" readonly placeholder="לחץ על 'הפעל שיתוף'" />
                <button id="btnCopyShare" class="btn">העתק קישור</button>
              </div>
              <p class="muted">קישור שיתוף יציג <strong>יומן יומי</strong> ו<strong>מפה</strong> בלבד, עם סימוני "איפה טיילתי" בלבד.</p>
            </div>
          </div>
        </section>

        <section id="welcome" class="tabview">
          <div class="trip-card">
            <h2>ברוכים הבאים ל‑FLYMILY</h2>
            <p class="muted">התחברו כדי לנהל, לעקוב, ולשתף טיולים — בעברית ובכיווניות RTL.</p>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- מודאלים -->
  <dialog id="authModal" class="modal">
    <header><strong>התחברות / הרשמה</strong></header>
    <div class="body">
      <label>אימייל<input id="authEmail" type="email" class="input" placeholder="name@example.com"/></label>
      <label>סיסמה<input id="authPass" type="password" class="input" placeholder="••••••••"/></label>
      <p id="authError" class="muted" style="color:var(--danger);"></p>
    </div>
    <div class="footer">
      <button id="authSignIn" class="btn primary">כניסה</button>
      <button id="authSignUp" class="btn">הרשמה</button>
      <button id="authReset" class="btn">איפוס סיסמה</button>
      <button id="authCancel" class="btn ghost">ביטול</button>
    </div>
  </dialog>

  <dialog id="tripModal" class="modal">
    <header><strong>נסיעה חדשה</strong></header>
    <div class="body">
      <label>יעד<input id="tripDest" class="input"/></label>
      <div class="row"><label>תאריך התחלה<input type="date" id="tripStart" class="input"></label><label>תאריך סיום<input type="date" id="tripEnd" class="input"></label></div>
    </div>
    <div class="footer">
      <button id="tripSave" class="btn primary">שמור</button>
      <button id="tripCancel" class="btn ghost">ביטול</button>
    </div>
  </dialog>

  <dialog id="expenseModal" class="modal">
    <header><strong>הוצאה</strong></header>
    <div class="body">
      <label>תיאור<input id="expDesc" class="input"/></label>
      <label>קטגוריה<input id="expCat" class="input" placeholder="לינה/תחבורה/אוכל/בידור..."/></label>
      <div class="row"><label>סכום<input id="expAmount" type="number" step="0.01" class="input"></label><label>מטבע<select id="expCurr" class="input"><option>USD</option><option>EUR</option><option>ILS</option></select></label></div>
      <div class="row"><label>רוחב<input id="expLat" type="number" step="0.000001" class="input" placeholder="אופציונלי"></label><label>אורך<input id="expLng" type="number" step="0.000001" class="input" placeholder="אופציונלי"></label></div>
    </div>
    <div class="footer">
      <button id="expSave" class="btn primary">שמור</button>
      <button id="expDelete" class="btn danger" style="display:none">מחק</button>
      <button id="expCancel" class="btn ghost">ביטול</button>
    </div>
  </dialog>

  <dialog id="journalModal" class="modal">
    <header><strong>רישום יומן</strong></header>
    <div class="body">
      <label>תיאור<textarea id="jrText" class="input"></textarea></label>
      <label>שם מקום<input id="jrPlace" class="input"/></label>
      <div class="row"><label>רוחב<input id="jrLat" type="number" step="0.000001" class="input" placeholder="אופציונלי"></label><label>אורך<input id="jrLng" type="number" step="0.000001" class="input" placeholder="אופציונלי"></label></div>
    </div>
    <div class="footer">
      <button id="jrSave" class="btn primary">שמור</button>
      <button id="jrDelete" class="btn danger" style="display:none">מחק</button>
      <button id="jrCancel" class="btn ghost">ביטול</button>
    </div>
  </dialog>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

  <!-- Firebase + App scripts -->
  <script type="module" src="./firebase.js"></script>
  <script type="module" src="./script.js"></script>
</body>
</html>
