<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FLYMILY — האפליקציה</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --brand:#2563eb; --danger:#ef4444; }
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg); color:var(--text); display:grid; place-items:center;
    }
    .card{
      width:min(960px,92vw); background:var(--card); border-radius:18px; box-shadow:0 10px 30px rgba(2,8,23,.06);
      padding:28px; display:flex; flex-direction:column; gap:20px;
    }
    h1{margin:0 0 6px; font-size:28px; letter-spacing:.5px}
    .sub{color:var(--muted); font-size:14px}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between}
    .pill{padding:6px 12px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:13px}
    .btn{padding:12px 16px; border-radius:12px; border:none; cursor:pointer; font-weight:600}
    .btn.brand{background:var(--brand); color:#fff}
    .btn.outline{background:#fff; border:1px solid #e5e7eb}
    .btn.danger{background:var(--danger); color:#fff}
    .grid{display:grid; grid-template-columns:repeat(12,1fr); gap:14px}
    .tile{grid-column:span 12; padding:16px; border:1px solid #eef; border-radius:12px; background:#fff}
    .muted{color:var(--muted)}
    @media (min-width:720px){
      .tile{grid-column:span 6}
    }
    .hide{display:none}
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <div>
        <h1>FLYMILY — לוח טיולים</h1>
        <div class="sub">מסך אפליקציה לאחר התחברות ב-Magic Link</div>
      </div>
      <div class="row" style="gap:8px">
        <span class="pill"><strong id="status">בודק מצב…</strong></span>
        <span class="pill muted" id="email">—</span>
      </div>
    </div>

    <div class="row">
      <button class="btn outline" id="home">חזרה למסך כניסה</button>
      <div style="display:flex; gap:10px">
        <button class="btn brand" id="refresh">רענון</button>
        <button class="btn danger" id="logout">התנתקות מלאה</button>
      </div>
    </div>

    <div class="grid" id="appContent" class="hide">
      <div class="tile">
        <strong>ברוך/ה הבא/ה!</strong>
        <div class="muted">זהו מקום לתוכן האמיתי של האפליקציה (כרטיסים, טבלאות, וכו').</div>
      </div>
      <div class="tile">
        <div class="muted">אפשר להחליף את הבלוקים האלו ברכיבים שלך או להטמיע כאן SPA קיימת.</div>
      </div>
    </div>

    <div class="muted" style="font-size:12px">
      אם עברת לכאן ישירות מהאימייל, הדף משלים אוטומטית את ה-Magic Link. אם אינך מחובר/ת יבוצע ניתוב חזרה למסך הכניסה.
    </div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signOut,
      isSignInWithEmailLink, signInWithEmailLink
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // === הקונפיג שהעברת לי ===
    const firebaseConfig = {
      apiKey: "AIzaSyArvkyWzgOmPjYYXUIOdilmtfrWt7WxK-0",
      authDomain: "travel-416ff.firebaseapp.com",
      projectId: "travel-416ff",
      storageBucket: "travel-416ff.firebasestorage.app",
      messagingSenderId: "1075073511694",
      appId: "1:1075073511694:web:7876f492d18a702b09e75f",
      measurementId: "G-FT56H33X5J"
    };

    // אתחול (מונע כפילות אם נטען שוב)
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth();

    // אם הדף נפתח מתוך המייל – משלים את ה-Magic Link
    async function completeMagicIfNeeded() {
      try {
        if (isSignInWithEmailLink(auth, window.location.href)) {
          let email = sessionStorage.getItem("emailForSignIn") || prompt("הכניסו את האימייל שאיתו התחברתם:");
          if (email) {
            await signInWithEmailLink(auth, email, window.location.href);
            sessionStorage.removeItem("emailForSignIn");
            history.replaceState({}, "", window.location.pathname); // מנקה פרמטרים מה-URL
          }
        }
      } catch (err) {
        console.error(err);
        alert("שגיאה בהשלמת הכניסה: " + (err?.message || err));
      }
    }
    await completeMagicIfNeeded();

    const statusEl = document.getElementById("status");
    const emailEl  = document.getElementById("email");
    const appContent = document.getElementById("appContent");

    // מאזין למצב ההתחברות
    onAuthStateChanged(auth, (user) => {
      if (user) {
        statusEl.textContent = "מחובר";
        emailEl.textContent = user.email || "—";
        appContent.classList.remove("hide");
      } else {
        // לא מחובר → חזרה למסך ההתחברות בשורש
        window.location.href = "../";
      }
    });

    // פעולות UI
    document.getElementById("logout").addEventListener("click", async () => {
      try { await signOut(auth); } catch(e){ console.error(e); }
      window.location.href = "../?signedout=1";
    });

    document.getElementById("home").addEventListener("click", () => {
      window.location.href = "../";
    });

    document.getElementById("refresh").addEventListener("click", () => {
      location.reload();
    });
  </script>
</body>
</html>
